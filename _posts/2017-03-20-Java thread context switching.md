---
layout: post
title:  "Java 线程上下文切换"
date:   2017-03-20 11:25:21 +0800
categories: Java thread context switching
tag: Java
---

## 线程上下文切换

利用时间片转轮的方式。CPU给每个任务都设置一定的时间，然后把当前任务的状态保存下来，在加载下一任务的状态后，继续服务下一个任务。
任务的状态保存及再加载，这段过程就叫做上下文切换。时间片轮转的方式使多个任务在同一颗CPU上执行变成可能。

### 进程

是指程序运行的实例，在linux系统中线程就是能并行运行且与他们的父进程（创建他们的进程）共享同一地址空间（一段内存区域）和其他资源的轻量级的进程。

### 上下文

是指某一个时间点CPU寄存器和程序计数器的内容。

### 寄存器

是指CPU内部的数量较少但是速度很快的内存（与之对应的是CPU外部相对较慢的RAM主内存）。寄存器通过对常用值（通常是运算的中间值）的快速访问来提高计算机程序运行的速度。

### 程序计算器

是一个专门的寄存器，用于表明指令序列中CPU正在执行的位置，存的值为正在执行的指令的位置或下一个将要被执行的指令的位置，具体依赖于特定的系统。

### PCB-切换帧

上下文切换可以认为是内核（操作系统的核心）在CPU上对于进程（包括线程）进行切换，上下文切换过程中的信息是保存在进程控制块（PCB）中的。
PCB经常被称为切换帧，信息会一直保存到CPU的内存中，直到他们被再次使用。

## 上下文切换的活动

1. 挂起一个进程，将进程的CPU状态（上下文）存储于内存中的某处。
2. 在内存中检索下一个进程的上下文并将其在CPU的寄存器中恢复。
3. 跳转到程序计数器所指向的位置（即跳转到进程被中断时的代码行），以恢复该进程在程序中。

## 引起线程上下文切换的原因

1. 当前执行任务的时间片用完之后，系统CPU正常调度下一个任务。
2. 当前执行任务碰到IO阻塞，调度器将此任务挂起，继续下一个任务。
3. 多个任务抢占锁资源，当前任务没有抢到锁资源，当调度器挂起，继续下一个任务。
4. 用户代码挂起当前任务，让出CPU时间。
5. 硬件中断。